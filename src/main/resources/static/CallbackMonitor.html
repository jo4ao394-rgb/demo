<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ è—æ–°é‡‘æµå›èª¿ç›£æ§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 20px 20px 0 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 32px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .content {
            background: white;
            padding: 40px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .status-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .status-row:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: 600;
            color: #555;
        }
        
        .status-value {
            font-family: monospace;
            color: #333;
            font-size: 14px;
        }
        
        .status-ok {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .status-error {
            color: #f44336;
            font-weight: bold;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #FF9800;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .success-box {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e0e0e0;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .step-container {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }
        
        .step-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .step-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .callback-log {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .log-entry {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            background: rgba(255,255,255,0.05);
        }
        
        .log-success {
            border-left: 3px solid #4CAF50;
        }
        
        .log-error {
            border-left: 3px solid #f44336;
        }
        
        .log-info {
            border-left: 3px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ è—æ–°é‡‘æµå›èª¿ç›£æ§ä¸­å¿ƒ</h1>
            <p>Callback API Setup & Monitoring</p>
        </div>
        
        <div class="content">
            <!-- ç•¶å‰ç‹€æ…‹ -->
            <h2 class="section-title">ğŸ“Š ç•¶å‰ç‹€æ…‹</h2>
            
            <div class="status-card">
                <div class="status-row">
                    <span class="status-label">æ‡‰ç”¨ç¨‹å¼</span>
                    <span class="status-value status-ok" id="appStatus">æª¢æŸ¥ä¸­...</span>
                </div>
                <div class="status-row">
                    <span class="status-label">å›èª¿ç«¯é»</span>
                    <span class="status-value" id="callbackEndpoint">http://localhost:8080/api/notify</span>
                </div>
                <div class="status-row">
                    <span class="status-label">è¨­å®šçš„å›èª¿ URL</span>
                    <span class="status-value" id="configuredUrl">è¼‰å…¥ä¸­...</span>
                </div>
                <div class="status-row">
                    <span class="status-label">ngrok ç‹€æ…‹</span>
                    <span class="status-value" id="ngrokStatus">æœªè¨­å®š</span>
                </div>
            </div>
            
            <!-- å•é¡Œèªªæ˜ -->
            <h2 class="section-title">â“ ç‚ºä»€éº¼éœ€è¦ ngrokï¼Ÿ</h2>
            
            <div class="warning-box">
                <strong>âš ï¸ æœ¬åœ°é–‹ç™¼çš„é™åˆ¶ï¼š</strong>
                <p style="margin-top: 10px;">
                    è—æ–°é‡‘æµéœ€è¦ä¸€å€‹<strong>å…¬é–‹å¯å­˜å–çš„ URL</strong> ä¾†ç™¼é€ä»˜æ¬¾å®Œæˆé€šçŸ¥ã€‚
                    ä½†æ‚¨çš„é–‹ç™¼ç’°å¢ƒé‹è¡Œåœ¨ <code>localhost:8080</code>ï¼Œè—æ–°é‡‘æµç„¡æ³•å¾ç¶²éš›ç¶²è·¯å­˜å–åˆ°å®ƒã€‚
                </p>
            </div>
            
            <div class="info-box">
                <strong>âœ… è§£æ±ºæ–¹æ¡ˆï¼š</strong>
                <p style="margin-top: 10px;">
                    <strong>ngrok</strong> å¯ä»¥å»ºç«‹ä¸€å€‹å…¬é–‹çš„è‡¨æ™‚ç¶²å€ï¼ˆä¾‹å¦‚ï¼š<code>https://abc-123.ngrok-free.app</code>ï¼‰ï¼Œ
                    å°‡è—æ–°é‡‘æµçš„å›èª¿è«‹æ±‚è½‰ç™¼åˆ°æ‚¨çš„æœ¬åœ° <code>localhost:8080</code>ã€‚
                </p>
            </div>
            
            <!-- è¨­å®šæ­¥é©Ÿ -->
            <h2 class="section-title">ğŸš€ è¨­å®šæ­¥é©Ÿ</h2>
            
            <div class="step-container">
                <div class="step-number">1</div>
                <div class="step-content">
                    <div class="step-title">å®‰è£ ngrok</div>
                    <div class="code-block">brew install ngrok</div>
                    <p style="margin-top: 8px; font-size: 14px; color: #666;">
                        æˆ–å¾å®˜ç¶²ä¸‹è¼‰ï¼š<a href="https://ngrok.com/download" target="_blank">https://ngrok.com/download</a>
                    </p>
                </div>
            </div>
            
            <div class="step-container">
                <div class="step-number">2</div>
                <div class="step-content">
                    <div class="step-title">åœ¨æ–°çµ‚ç«¯è¦–çª—å•Ÿå‹• ngrok</div>
                    <div class="code-block">ngrok http 8080</div>
                    <p style="margin-top: 8px; font-size: 14px; color: #666;">
                        åŸ·è¡Œå¾Œæœƒé¡¯ç¤ºä¸€å€‹ <code>https://</code> é–‹é ­çš„ URLï¼Œè«‹è¤‡è£½å®ƒ
                    </p>
                </div>
            </div>
            
            <div class="step-container">
                <div class="step-number">3</div>
                <div class="step-content">
                    <div class="step-title">ä½¿ç”¨è‡ªå‹•åŒ–è…³æœ¬è¨­å®š</div>
                    <div class="code-block">./setup_callback.sh</div>
                    <p style="margin-top: 8px; font-size: 14px; color: #666;">
                        è…³æœ¬æœƒè‡ªå‹•æ›´æ–°é…ç½®ä¸¦é‡å•Ÿæ‡‰ç”¨ç¨‹å¼
                    </p>
                    <button class="btn btn-primary" onclick="openTerminal()">ğŸ“ è¤‡è£½æŒ‡ä»¤</button>
                </div>
            </div>
            
            <div class="step-container">
                <div class="step-number">4</div>
                <div class="step-content">
                    <div class="step-title">æ¸¬è©¦å›èª¿</div>
                    <div class="code-block">./test_callback.sh</div>
                    <p style="margin-top: 8px; font-size: 14px; color: #666;">
                        æ¸¬è©¦å›èª¿ API æ˜¯å¦æ­£å¸¸é‹ä½œï¼ˆä¸éœ€è¦çœŸæ­£ä»˜æ¬¾ï¼‰
                    </p>
                    <button class="btn btn-primary" onclick="testCallback()">ğŸ§ª åŸ·è¡Œæ¸¬è©¦</button>
                </div>
            </div>
            
            <!-- å¿«é€Ÿæ¸¬è©¦ -->
            <h2 class="section-title">ğŸ§ª å¿«é€Ÿæ¸¬è©¦</h2>
            
            <div class="success-box">
                <strong>âœ… æœ¬åœ°æ¸¬è©¦ï¼ˆä¸éœ€è¦ ngrokï¼‰ï¼š</strong>
                <p style="margin-top: 10px;">
                    æ‚¨å¯ä»¥åœ¨ä¸è¨­å®š ngrok çš„æƒ…æ³ä¸‹æ¸¬è©¦å›èª¿ API çš„ç¨‹å¼é‚è¼¯ã€‚
                    é»æ“Šä¸‹æ–¹æŒ‰éˆ•æœƒæ¨¡æ“¬è—æ–°é‡‘æµç™¼é€å›èª¿è«‹æ±‚åˆ°æœ¬åœ°ç«¯é»ã€‚
                </p>
                <button class="btn btn-primary" onclick="simulateCallback()" style="margin-top: 10px;">
                    ğŸš€ æ¨¡æ“¬å›èª¿è«‹æ±‚
                </button>
            </div>
            
            <!-- å›èª¿æ—¥èªŒ -->
            <h2 class="section-title">ğŸ“ å›èª¿æ—¥èªŒ</h2>
            
            <div>
                <button class="btn btn-secondary" onclick="loadLogs()">ğŸ”„ é‡æ–°è¼‰å…¥æ—¥èªŒ</button>
                <button class="btn btn-secondary" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºé¡¯ç¤º</button>
            </div>
            
            <div class="callback-log" id="logContainer">
                <div class="log-entry log-info">ç­‰å¾…æ—¥èªŒ...</div>
                <div class="log-entry log-info" style="opacity: 0.6;">
                    æç¤ºï¼šå®Œæˆä»˜æ¬¾å¾Œï¼Œå›èª¿æ—¥èªŒæœƒè‡ªå‹•é¡¯ç¤ºåœ¨é€™è£¡
                </div>
            </div>
            
            <!-- ngrok ç®¡ç†ä»‹é¢ -->
            <h2 class="section-title">ğŸŒ ngrok ç®¡ç†ä»‹é¢</h2>
            
            <div class="info-box">
                <strong>ğŸ“Š æŸ¥çœ‹è©³ç´°è«‹æ±‚è³‡è¨Šï¼š</strong>
                <p style="margin-top: 10px;">
                    å¦‚æœæ‚¨å·²å•Ÿå‹• ngrokï¼Œå¯ä»¥è¨ªå•å…¶ Web ç®¡ç†ä»‹é¢æŸ¥çœ‹æ‰€æœ‰é€²ä¾†çš„ HTTP è«‹æ±‚ï¼Œ
                    åŒ…æ‹¬è—æ–°é‡‘æµç™¼é€çš„å›èª¿è«‹æ±‚ã€‚é€™å°é™¤éŒ¯éå¸¸æœ‰å¹«åŠ©ï¼
                </p>
                <button class="btn btn-primary" onclick="openNgrokDashboard()" style="margin-top: 10px;">
                    ğŸ“ˆ é–‹å•Ÿ ngrok ç®¡ç†ä»‹é¢
                </button>
            </div>
            
            <!-- å¸¸è¦‹å•é¡Œ -->
            <h2 class="section-title">â“ å¸¸è¦‹å•é¡Œ</h2>
            
            <details style="margin-bottom: 15px;">
                <summary style="cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 5px; font-weight: 600;">
                    Q: ç‚ºä»€éº¼æ”¶ä¸åˆ°å›èª¿é€šçŸ¥ï¼Ÿ
                </summary>
                <div style="padding: 15px; background: #f8f9fa; margin-top: 5px; border-radius: 5px;">
                    <p>è«‹æª¢æŸ¥ä»¥ä¸‹é …ç›®ï¼š</p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>âœ… ngrok æ˜¯å¦æ­£åœ¨é‹è¡Œï¼Ÿ</li>
                        <li>âœ… application.yml çš„ notify-url æ˜¯å¦å·²æ›´æ–°ç‚º ngrok URLï¼Ÿ</li>
                        <li>âœ… æ‡‰ç”¨ç¨‹å¼æ˜¯å¦å·²ä½¿ç”¨æ–°é…ç½®é‡å•Ÿï¼Ÿ</li>
                        <li>âœ… ä»˜æ¬¾æ˜¯å¦çœŸçš„å®Œæˆï¼Ÿï¼ˆæ¸¬è©¦ç’°å¢ƒä¹Ÿæœƒç™¼é€å›èª¿ï¼‰</li>
                    </ul>
                </div>
            </details>
            
            <details style="margin-bottom: 15px;">
                <summary style="cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 5px; font-weight: 600;">
                    Q: ngrok URL æ¯æ¬¡éƒ½ä¸ä¸€æ¨£æ€éº¼è¾¦ï¼Ÿ
                </summary>
                <div style="padding: 15px; background: #f8f9fa; margin-top: 5px; border-radius: 5px;">
                    <p>å…è²»ç‰ˆ ngrok æ¯æ¬¡å•Ÿå‹•éƒ½æœƒç”¢ç”Ÿä¸åŒçš„ URLã€‚æ‚¨å¯ä»¥ï¼š</p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>ä½¿ç”¨ <code>./setup_callback.sh</code> è…³æœ¬å¿«é€Ÿæ›´æ–°é…ç½®</li>
                        <li>æˆ–å‡ç´šåˆ°ä»˜è²»ç‰ˆå–å¾—å›ºå®šçš„ URL</li>
                    </ul>
                </div>
            </details>
            
            <details style="margin-bottom: 15px;">
                <summary style="cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 5px; font-weight: 600;">
                    Q: æ­£å¼ç’°å¢ƒå¦‚ä½•è¨­å®šï¼Ÿ
                </summary>
                <div style="padding: 15px; background: #f8f9fa; margin-top: 5px; border-radius: 5px;">
                    <p>æ­£å¼ç’°å¢ƒä¸éœ€è¦ ngrokï¼Œç›´æ¥ä½¿ç”¨æ‚¨çš„ç¶²åŸŸåç¨±ï¼š</p>
                    <div class="code-block" style="margin-top: 10px;">notify-url: 'https://your-domain.com/api/notify'</div>
                    <p style="margin-top: 10px;">ç¢ºä¿ï¼š</p>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>ä½¿ç”¨ HTTPSï¼ˆè—æ–°è¦æ±‚ï¼‰</li>
                        <li>ç¶²åŸŸåç¨±å¯ä»¥å¾ç¶²éš›ç¶²è·¯å­˜å–</li>
                        <li>é˜²ç«ç‰†å…è¨±è—æ–°é‡‘æµçš„ IP</li>
                    </ul>
                </div>
            </details>
        </div>
    </div>
    
    <script>
        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç‹€æ…‹
        window.onload = function() {
            checkAppStatus();
            loadLogs();
        };
        
        // æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
        async function checkAppStatus() {
            const statusEl = document.getElementById('appStatus');
            
            try {
                const response = await fetch('http://localhost:8080/api/pay', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    statusEl.textContent = 'âœ… é‹è¡Œä¸­';
                    statusEl.className = 'status-value status-ok';
                } else {
                    statusEl.textContent = 'âš ï¸ ç•°å¸¸';
                    statusEl.style.color = '#FF9800';
                }
            } catch (error) {
                statusEl.textContent = 'âŒ æœªé‹è¡Œ';
                statusEl.className = 'status-value status-error';
            }
        }
        
        // æ¨¡æ“¬å›èª¿è«‹æ±‚
        async function simulateCallback() {
            const logContainer = document.getElementById('logContainer');
            
            try {
                // 1. å–å¾—ä»˜æ¬¾è³‡æ–™
                addLog('info', 'æ­£åœ¨ç”¢ç”Ÿæ¸¬è©¦ä»˜æ¬¾è³‡æ–™...');
                const payResponse = await fetch('http://localhost:8080/api/pay', {
                    method: 'POST'
                });
                const payData = await payResponse.json();
                
                addLog('success', `ä»˜æ¬¾è³‡æ–™å·²ç”¢ç”Ÿ (TradeInfo: ${payData.TradeInfo.substring(0, 40)}...)`);
                
                // 2. ç™¼é€æ¨¡æ“¬å›èª¿
                addLog('info', 'ç™¼é€æ¨¡æ“¬å›èª¿è«‹æ±‚åˆ° /api/notify...');
                
                const formData = new URLSearchParams();
                formData.append('Status', 'SUCCESS');
                formData.append('MerchantID', payData.MerchantID);
                formData.append('TradeInfo', payData.TradeInfo);
                formData.append('TradeSha', payData.TradeSha);
                
                const callbackResponse = await fetch('http://localhost:8080/api/notify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData
                });
                
                if (callbackResponse.ok) {
                    const result = await callbackResponse.text();
                    addLog('success', `âœ… å›èª¿æˆåŠŸï¼å›æ‡‰: ${result}`);
                } else {
                    addLog('error', `âŒ å›èª¿å¤±æ•— (HTTP ${callbackResponse.status})`);
                }
                
            } catch (error) {
                addLog('error', `âŒ éŒ¯èª¤: ${error.message}`);
            }
        }
        
        // æ·»åŠ æ—¥èªŒ
        function addLog(type, message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString('zh-TW', { hour12: false });
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // é™åˆ¶æ—¥èªŒæ•¸é‡
            while (logContainer.children.length > 20) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }
        
        // è¼‰å…¥æ—¥èªŒ
        function loadLogs() {
            addLog('info', 'æ—¥èªŒè¼‰å…¥åŠŸèƒ½é–‹ç™¼ä¸­... è«‹ä½¿ç”¨çµ‚ç«¯æŸ¥çœ‹å®Œæ•´æ—¥èªŒ');
            addLog('info', 'æŒ‡ä»¤: tail -f /tmp/newwebpay_test.log | grep notify');
        }
        
        // æ¸…ç©ºæ—¥èªŒé¡¯ç¤º
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '<div class="log-entry log-info">æ—¥èªŒå·²æ¸…ç©º</div>';
        }
        
        // é–‹å•Ÿ ngrok ç®¡ç†ä»‹é¢
        function openNgrokDashboard() {
            window.open('http://127.0.0.1:4040', '_blank');
        }
        
        // é–‹å•Ÿçµ‚ç«¯
        function openTerminal() {
            alert('è«‹åœ¨çµ‚ç«¯åŸ·è¡Œ:\n\n./setup_callback.sh');
        }
        
        // æ¸¬è©¦å›èª¿
        function testCallback() {
            alert('è«‹åœ¨çµ‚ç«¯åŸ·è¡Œ:\n\n./test_callback.sh');
        }
    </script>
</body>
</html>
